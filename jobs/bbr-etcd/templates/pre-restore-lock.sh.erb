#!/bin/bash -eu

source /var/vcap/packages/tools/scripts/common.sh
etcd_store_dir=''; backup_data_before_restore='';
source /var/vcap/jobs/bbr-etcd/bin/bbr/bbr-utils.sh
assert_declared_functions 'audit_log_ensure_access' 'log_audit' 'log_bbr' 'etcd_job_stop'
assert_non_empty_variables 'etcd_store_dir' 'backup_data_before_restore'

source /var/vcap/jobs/etcd/bin/etcd-functions.sh
assert_declared_functions 'etcd_remove_restoring_flag_file'

audit_log_ensure_access

log_audit "begin"

if etcd_job_stop; then
  log_bbr "etcd job is stopped"
else
  log_audit "failure: etcd job is NOT stopped"
  exit 1
fi

if [ -d "$etcd_store_dir/database/member" ]; then
  if [ "$backup_data_before_restore" == 'true' ]; then
    store_dir_bak_file="$etcd_store_dir/backup/database.pre-restore-bak-$(date +'%Y-%m-%d_%H-%M-%S').tar.gz"
    tar -cvf - -C "$etcd_store_dir/database/member" . | gzip -9 > "$store_dir_bak_file"
    log_bbr "previous data backup: $store_dir_bak_file"
  fi
fi

rm -rf "${etcd_store_dir:?}/database/"*
etcd_remove_restoring_flag_file "$etcd_store_dir"

log_audit "success"
